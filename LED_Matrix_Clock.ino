#include <Wire.h>
#include <LedControl.h>
#include "RTClib.h"

RTC_DS3231 rtc;
int sensorPin = A0;
int brightness = 0;
unsigned devices = 4;
LedControl lc = LedControl(12, 10, 11, devices);
unsigned int repeat=0;

byte digits [60][8] = {
  {B01111100, B01000100, B01111100, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01111100, B00000000, B00000000, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01110100, B01010100, B01011100, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01111100, B01010100, B01010100, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01111100, B00010000, B01110000, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01011100, B01010100, B01110100, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01011100, B01010100, B01111100, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01111100, B01000000, B01000000, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01111100, B01010100, B01111100, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01111100, B01010100, B01110100, B00000000, B01111100, B01000100, B01111100, B00000000},
  {B01111100, B01000100, B01111100, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01111100, B00000000, B00000000, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01110100, B01010100, B01011100, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01111100, B01010100, B01010100, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01111100, B00010000, B01110000, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01011100, B01010100, B01110100, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01011100, B01010100, B01111100, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01111100, B01000000, B01000000, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01111100, B01010100, B01111100, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01111100, B01010100, B01110100, B00000000, B01111100, B00000000, B00000000, B00000000},
  {B01111100, B01000100, B01111100, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01111100, B00000000, B00000000, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01110100, B01010100, B01011100, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01111100, B01010100, B01010100, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01111100, B00010000, B01110000, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01011100, B01010100, B01110100, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01011100, B01010100, B01111100, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01111100, B01000000, B01000000, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01111100, B01010100, B01111100, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01111100, B01010100, B01110100, B00000000, B01110100, B01010100, B01011100, B00000000},
  {B01111100, B01000100, B01111100, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01111100, B00000000, B00000000, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01110100, B01010100, B01011100, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01111100, B01010100, B01010100, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01111100, B00010000, B01110000, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01011100, B01010100, B01110100, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01011100, B01010100, B01111100, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01111100, B01000000, B01000000, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01111100, B01010100, B01111100, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01111100, B01010100, B01110100, B00000000, B01111100, B01010100, B01010100, B00000000},
  {B01111100, B01000100, B01111100, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01111100, B00000000, B00000000, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01110100, B01010100, B01011100, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01111100, B01010100, B01010100, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01111100, B00010000, B01110000, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01011100, B01010100, B01110100, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01011100, B01010100, B01111100, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01111100, B01000000, B01000000, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01111100, B01010100, B01111100, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01111100, B01010100, B01110100, B00000000, B01111100, B00010000, B01110000, B00000000},
  {B01111100, B01000100, B01111100, B00000000, B01011100, B01010100, B01110100, B00000000},
  {B01111100, B00000000, B00000000, B00000000, B01011100, B01010100, B01110100, B00000000},
  {B01110100, B01010100, B01011100, B00000000, B01011100, B01010100, B01110100, B00000000},
  {B01111100, B01010100, B01010100, B00000000, B01011100, B01010100, B01110100, B00000000},
  {B01111100, B00010000, B01110000, B00000000, B01011100, B01010100, B01110100, B00000000},
  {B01011100, B01010100, B01110100, B00000000, B01011100, B01010100, B01110100, B00000000},
  {B01011100, B01010100, B01111100, B00000000, B01011100, B01010100, B01110100, B00000000},
  {B01111100, B01000000, B01000000, B00000000, B01011100, B01010100, B01110100, B00000000},
  {B01111100, B01010100, B01111100, B00000000, B01011100, B01010100, B01110100, B00000000},
  {B01111100, B01010100, B01110100, B00000000, B01011100, B01010100, B01110100, B00000000}
};

byte mode [2][8] = {
  {B00000000, B00011000, B00100100, B01000010, B01000010, B01111110, B00000000, B00000000},
  {B00000000, B01000000, B01000000, B01111110, B01000000, B01000000, B00000000, B00000000}
};

void setup() {
//  pinMode(sensorPin, INPUT);
  rtc.begin();
  for(unsigned address = 0; address < devices; address++) {
    lc.shutdown(address, false);
    lc.clearDisplay(address);
  }
}

void loop() {
  brightness = ((1023 - analogRead(sensorPin)) / 256) - 1;
 if (brightness < 0) {brightness = 0;}
  for (unsigned address = 0; address < devices; address++) {
    lc.setIntensity(address, brightness);
   DateTime t = rtc.now();
  if(repeat<=60)
      for (unsigned row = 0; row < 9; row++) {
        lc.setRow(0, row, digits[t.year()%100][row]);
        lc.setRow(1, row, digits[t.month()][row]);
        lc.setRow(2, row, digits[t.day()][row]);
        lc.setRow(3, row, mode[0][row]);
        }
  else
  for (unsigned row = 0; row < 9; row++) {
        lc.setRow(0, row, digits[t.second()][row]);
        lc.setRow(1, row, digits[t.minute()][row]);
        lc.setRow(2, row, digits[t.hour()][row]);
        lc.setRow(3, row, mode[1][row]);
       }
  };
  if (repeat>=120)
    repeat=0;
    repeat++;
    delay(100);
 }
